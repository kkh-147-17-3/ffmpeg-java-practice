<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <title>Document</title>
</head>
<body>
    <nav class="navbar navbar-dark bg-primary">
        <a class="navbar-brand" href="#">Shoplive Backend Test - 김경환</a>
      </nav>
    <div id="upload-video">
        <div>
            <label class="form-label" for="input-video">동영상을 선택해주세요.</label>
            <input type="file" class="form-control" id="input-video" />
        </div>
        <div class="form-outlline">
            <label class="form-label" for="input-title">동영상 제목</label>
            <input class="form-control" type="text" id="input-title" name="title" placeholder="Title">
        </div>
        
        <input type="button" value="Upload" class="btn btn-primary">
    </div>
    <fieldset style="margin-top:100px; width: 1200px; height: 300px;">
        <legend>업로드 결과</legend>
        <div style="display:flex; width:100%; column-gap:100px; justify-content:center;">
            <div>
                업로드 썸네일
                <img width="300" src="/default-image.png" alt="동영상 thumbnail">
            </div>
            <div>
                업로드 원본 영상
                <video width="300" controls id="original-video">
                    <source id="original-source" type="video/mp4">
                </video> 
            </div>
            
            <div>
                업로드 리자이징 영상
                <video width="300" controls id="resized-video">
                    <source id="resized-source" type="video/mp4">
                </video>
            </div>
        </div>
        <div>
            <span>Resize Progress: </span>
            <div class="progress">
                <div id="resize-progress" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%;"></div>
            </div>
            <span>Thumbnail Progress: </span>
            <div class="progress">
                <div id="thumbnail-progress" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%;"></div>
            </div>
        </div>
    </fieldset>
</body>
</html>

<script>

window.addEventListener('load', ()=>{
    const btn = document.querySelector('input[type="button"]');
    btn.onclick = uploadVideoHandler;
})

function uploadVideoHandler(e){
    const videoInput = document.querySelector('input[type="file"]');
    const titleInput = document.querySelector('#input-title');
    const img = document.querySelector('img');
    const originalVideo = document.querySelector('#original-video');
    const resizedVideo = document.querySelector('#resized-video');

    const originalSrc = document.querySelector('#original-source');
    const resizedSrc = document.querySelector('#resized-source');
    const resizeProgressBar = document.querySelector('#resize-progress');
    const thumbnailProgressBar = document.querySelector('#thumbnail-progress');

    const formData = new FormData();
    formData.append('videoFile', videoInput.files[0]);
    formData.append('metaInfo', new Blob([JSON.stringify(
        {
        title:titleInput.value,
    })], {
        type: "application/json"
    }));
    const option = {
        method:'POST',
        body:formData,
    }
    let interval;
    fetch('video',option)
    .then(res=>res.json())
    .then(data=>{
        const id = data.id;
        resizeProgressBar.innerText = "0%";
        resizeProgressBar.style.width = "0%";
        thumbnailProgressBar.innerText = "0%";
        thumbnailProgressBar.style.width = "0%";
        thumbnailProgressRequestInterval = setInterval(()=>requestThumbnailProgress(id),1000);
    });
    
    function requestResizeProgress(id){
        fetch(`/video/${id}/progress`)
        .then(res=>res.json())
        .then(data=>{
            console.log(data);
            resizeProgressBar.innerText = data.progress;
            resizeProgressBar.style.width = data.progress;
            if (data.progress === "100%") {
                requestDetails(id);
            }
        });
    }

    function requestThumbnailProgress(id){
        fetch(`/video/${id}/thumbnail/progress`)
        .then(res=>res.json())
        .then(data=>{
            thumbnailProgressBar.innerText = data.progress;
            thumbnailProgressBar.style.width = data.progress;
            if (data.progress === "100%") {
                clearInterval(thumbnailProgressRequestInterval);
                requestDetails(id);
                resizeProgressRequestInterval = setInterval(()=>requestResizeProgress(id),1000);
            }
        });
    }

    function requestDetails(id){
        fetch(`/video/${id}`)
        .then(res=>res.json())
        .then(data=>{
            if(data.thumbnailUrl){
                clearInterval(requestResizeProgress);
                img.src = data.thumbnailUrl;
            }
            if (data.original.videoUrl && !originalSrc.src){
                originalSrc.src = data.original.videoUrl;
                originalVideo.load();
                originalVideo.play();
            }
            if (data.resized.videoUrl){
                clearInterval(requestThumbnailProgress);
                resizedSrc.src = data.resized.videoUrl;
                clearInterval(resizeProgressRequestInterval);
                resizedVideo.load();
                resizedVideo.play();
            }
        })
    }
}
</script>